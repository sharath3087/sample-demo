name: Test File Upload to Azure

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: "Do you want to create a release?"
        required: true
        default: "No"
        type: choice
        options:
          - "Yes"
          - "No"
  push:
    branches: [main]
    paths-ignore:
      - ".github/**"
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_codesign:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Generate timestamp in mmddyyHHMMSS format
        shell: pwsh
        run: |
          $CURRENT_DATE_TIME = Get-Date -Format "MMddyyHHmmss"
          echo "CURRENT_DATE_TIME=$CURRENT_DATE_TIME" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          echo "Generated timestamp: $CURRENT_DATE_TIME"

      - name: Use timestamp in next step
        shell: pwsh
        run: |
          echo "Using timestamp: $env:CURRENT_DATE_TIME"
          echo "File name: backup-$env:CURRENT_DATE_TIME.zip"
          
      - name: Generate Build Metadata JSON
        run: |
          echo '{
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "workflow": "${{ github.workflow }}",
            "branch": "${{ github.ref_name }}",
            "commit_sha": "${{ github.sha }}",
            "commit_message": "'"$(git log -1 --pretty=%B)"'",
            "commit_author": "'"$(git log -1 --pretty=%an)"'",
            "timestamp": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'",
            "artifact_size_mb": "'"$(du -m dist/EzMigrateExtractor.zip | cut -f1)"'",
            "actor": "${{ github.actor }}",
            "workflow_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }'
